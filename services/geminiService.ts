// ЁЯЫС р╣Бр╕Бр╣Йр╣Др╕Вр╕Хр╕гр╕Зр╕Щр╕╡р╣Й: р╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╣Гр╕Кр╣Йр╕Бр╕▓р╕г Import р╕бр╕▓р╕Хр╕гр╕Рр╕▓р╕Щ @google/genai р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й Vite р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Бр╕▓р╕гр╕Фр╕╢р╕З Client SDK р╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
import { GoogleGenAI } from "@google/genai"; 
import { Student } from "../types";

// 1. р╣Гр╕Кр╣Й import.meta.env р╣Ар╕Юр╕╖р╣Ир╕нр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╕Хр╕▒р╕зр╣Бр╕Ыр╕гр╕кр╕ар╕▓р╕Юр╣Бр╕зр╕Фр╕ер╣Йр╕нр╕бр╕Чр╕╡р╣Ир╕Хр╕▒р╣Йр╕Зр╣Гр╕Щ .env.local 
const apiKey = import.meta.env.VITE_PUBLIC_GEMINI_API_KEY; 

// 2. р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕╡р╕вр╣М API р╣Бр╕ер╕░ Throw Error
if (!apiKey) {
┬а ┬а // р╕лр╕▓р╕Бр╕Др╕╡р╕вр╣Мр╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╕▒р╣Йр╕З р╕Ир╕░ Throw Error р╕Чр╕╡р╣Ир╕Кр╕▒р╕Фр╣Ар╕Ир╕Щр╣Бр╕Чр╕Щр╕Бр╕▓р╕г Crash р╣Бр╕Ър╕Ър╕лр╕Щр╣Йр╕▓р╕Вр╕▓р╕з
┬а ┬а throw new Error("GEMINI_API_KEY is missing. Please set VITE_PUBLIC_GEMINI_API_KEY in your .env.local file.");
}

// 3. р╕кр╕гр╣Йр╕▓р╕З Instance р╕Фр╣Йр╕зр╕вр╕Др╕╡р╕вр╣Мр╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕Фр╕╢р╕Зр╕бр╕▓р╕нр╕вр╣Ир╕▓р╕Зр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
const ai = new GoogleGenAI({ apiKey }); 

export const generateStudentAnalysis = async (student: Student): Promise<string> => {
┬а try {
┬а ┬а const scoresSummary = student.scores
┬а ┬а ┬а .map(s => `- ${s.subjectName}: ${s.score}/${s.fullScore} (р╣Ар╕Бр╕гр╕Ф ${s.grade})`)
┬а ┬а ┬а .join("\n");

┬а ┬а // Determine teacher gender and name for persona customization
┬а ┬а const teacherName = student.teachers[0] || "";
┬а ┬а const isMale = teacherName.startsWith("р╕Щр╕▓р╕в");
┬а ┬а const shortName = teacherName.split(' ')[0] || "р╕Др╕гр╕╣";
┬а ┬а 
┬а ┬а const genderRole = isMale ? "р╕Др╕гр╕╣р╕Ьр╕╣р╣Йр╕Кр╕▓р╕в" : "р╕Др╕гр╕╣р╕Ьр╕╣р╣Йр╕лр╕Нр╕┤р╕З";
┬а ┬а const endingParticle = isMale ? "р╕Др╕гр╕▒р╕Ъ" : "р╕Др╣Ир╕░";

┬а ┬а const prompt = `
┬а ┬а ┬а р╕Ър╕Чр╕Ър╕▓р╕Ч: р╕Др╕╕р╕Ур╕Др╕╖р╕н "${shortName}" р╕Лр╕╢р╣Ир╕Зр╣Ар╕Ыр╣Зр╕Щр╕Др╕гр╕╣р╕Ыр╕гр╕░р╕Ир╕│р╕Кр╕▒р╣Йр╕Щр╕гр╕░р╕Фр╕▒р╕Ър╕Ыр╕гр╕░р╕Цр╕бр╕ир╕╢р╕Бр╕йр╕▓р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щ${genderRole} р╕бр╕╡р╕Др╕зр╕▓р╕бр╣Гр╕Ир╕Фр╕╡ р╕нр╕Ър╕нр╕╕р╣Ир╕Щ р╣Бр╕ер╕░р╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╕Юр╕▒р╕Тр╕Щр╕▓р╕Бр╕▓р╕гр╣Ар╕Фр╣Зр╕Б
┬а ┬а ┬а р╕Зр╕▓р╕Щр╕Вр╕нр╕Зр╕Др╕╕р╕У: р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Ьр╕ер╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Щр╕Вр╕нр╕Зр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щр╕Кр╕▒р╣Йр╕Щ ${student.class} р╕Кр╕╖р╣Ир╕н "${student.firstName} ${student.lastName}" р╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕╖р╣Ир╕нр╕кр╕▓р╕гр╕Бр╕▒р╕Ър╕Ьр╕╣р╣Йр╕Ыр╕Бр╕Др╕гр╕нр╕Зр╣Бр╕ер╕░р╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ
┬а ┬а ┬а 
┬а ┬а ┬а р╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Бр╕▓р╕гр╕Юр╕╣р╕Ф (Tone of Voice):
┬а ┬а ┬а - р╕Хр╣Йр╕нр╕Зр╕ер╕Зр╕Чр╣Йр╕▓р╕вр╕Ыр╕гр╕░р╣Вр╕вр╕Др╕Фр╣Йр╕зр╕вр╕Др╕│р╕зр╣Ир╕▓ "${endingParticle}" р╣Ар╕кр╕бр╕н р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕кр╕Фр╕Зр╣Ар╕нр╕Бр╕ер╕▒р╕Бр╕йр╕Ур╣Мр╕Вр╕нр╕З${genderRole}
┬а ┬а ┬а - р╣Бр╕Чр╕Щр╕Хр╕▒р╕зр╣Ар╕нр╕Зр╕зр╣Ир╕▓ "р╕Др╕гр╕╣" р╕лр╕гр╕╖р╕н "${shortName}"
┬а ┬а ┬а - р╣Гр╕Кр╣Йр╕Щр╣Йр╕│р╣Ар╕кр╕╡р╕вр╕Зр╕нр╕Ър╕нр╕╕р╣Ир╕Щ р╣Ар╕Ыр╣Зр╕Щр╕Бр╕▒р╕Щр╣Ар╕нр╕З р╣Гр╕лр╣Йр╕Бр╕│р╕ер╕▒р╕Зр╣Гр╕И р╣Ар╕лр╕бр╕╖р╕нр╕Щр╕Бр╕│р╕ер╕▒р╕Зр╕Щр╕▒р╣Ир╕Зр╕Др╕╕р╕вр╕Бр╕▒р╕Ър╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щр╣Бр╕ер╕░р╕Ьр╕╣р╣Йр╕Ыр╕Бр╕Др╕гр╕нр╕Зр╕Хр╣Ир╕нр╕лр╕Щр╣Йр╕▓
┬а ┬а ┬а - р╕лр╕ер╕╡р╕Бр╣Ар╕ер╕╡р╣Ир╕вр╕Зр╕ар╕▓р╕йр╕▓р╕Чр╕▓р╕Зр╕Бр╕▓р╕гр╕Чр╕╡р╣Ир╣Бр╕Вр╣Зр╕Зр╕Бр╕гр╕░р╕Фр╣Йр╕▓р╕З

┬а ┬а ┬а р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕ер╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Щ:
┬а ┬а ┬а ${scoresSummary}
┬а ┬а ┬а р╕Др╕░р╣Бр╕Щр╕Щр╣Ар╕Йр╕ер╕╡р╣Ир╕в (GPA): ${student.gpa}

┬а ┬а ┬а р╕Бр╕гр╕╕р╕Ур╕▓р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Бр╕ер╕░р╣Гр╕лр╣Йр╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╕лр╕▒р╕зр╕Вр╣Йр╕нр╕Фр╕▒р╕Зр╕Щр╕╡р╣Й (р╣Гр╕Кр╣Й Emoji р╕Ыр╕гр╕░р╕Бр╕нр╕Ър╣Гр╕лр╣Йр╕Щр╣Ир╕▓р╕нр╣Ир╕▓р╕Щ):

┬а ┬а ┬а 1. ЁЯМЯ **р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╕лр╕Щр╕╣р╕Чр╕│р╣Др╕Фр╣Йр╕Фр╕╡р╣Ар╕вр╕╡р╣Ир╕вр╕б**: р╕Кр╕╖р╣Ир╕Щр╕Кр╕бр╕зр╕┤р╕Кр╕▓р╕Чр╕╡р╣Ир╕Др╕░р╣Бр╕Щр╕Щр╕Фр╕╡ р╣Бр╕ер╕░р╕Чр╕▒р╕Бр╕йр╕░р╕Чр╕╡р╣Ир╣Вр╕Фр╕Фр╣Ар╕Фр╣Ир╕Щр╕Вр╕нр╕Зр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ
┬а ┬а ┬а 2. ЁЯТб **р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╕Юр╕▒р╕Тр╕Щр╕▓р╣Др╕Фр╣Йр╕нр╕╡р╕Б**: р╕зр╕┤р╕Кр╕▓р╕Чр╕╡р╣Ир╕Др╕░р╣Бр╕Щр╕Щр╕Щр╣Йр╕нр╕вр╕Бр╕зр╣Ир╕▓р╕зр╕┤р╕Кр╕▓р╕нр╕╖р╣Ир╕Щ (р╕Цр╣Йр╕▓р╕бр╕╡) р╣Бр╕ер╕░р╣Бр╕Щр╕░р╕Щр╕│р╕зр╕┤р╕Шр╕╡р╕Эр╕╢р╕Бр╕Эр╕Щр╕Зр╣Ир╕▓р╕вр╣Ж р╕Чр╕╡р╣Ир╕Чр╕│р╣Др╕Фр╣Йр╕Чр╕╡р╣Ир╕Ър╣Йр╕▓р╕Щ
┬а ┬а ┬а 3. ЁЯУЦ **р╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ьр╕╣р╣Йр╕Ыр╕Бр╕Др╕гр╕нр╕З**: р╣Бр╕Щр╕░р╕Щр╕│р╕зр╕┤р╕Шр╕╡р╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕Бр╕▓р╕гр╣Ар╕гр╕╡р╕вр╕Щр╕гр╕╣р╣Йр╣Гр╕лр╣Йр╕ер╕╣р╕Бр╕нр╕вр╣Ир╕▓р╕Зр╕бр╕╡р╕Др╕зр╕▓р╕бр╕кр╕╕р╕В
┬а ┬а ┬а 4. ЁЯМИ **р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕лр╣Йр╕Бр╕│р╕ер╕▒р╕Зр╣Гр╕Ир╕Ир╕▓р╕Б${shortName}**: р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕кр╕▒р╣Йр╕Щр╣Ж р╣Ар╕Юр╕╖р╣Ир╕нр╕кр╕гр╣Йр╕▓р╕Зр╕Др╕зр╕▓р╕бр╕бр╕▒р╣Ир╕Щр╣Гр╕Ир╣Гр╕лр╣Йр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щр╕ар╕╣р╕бр╕┤р╣Гр╕Ир╣Гр╕Щр╕Хр╕▒р╕зр╣Ар╕нр╕З

┬а ┬а ┬а р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕: р╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╕Фр╕╕р╕лр╕гр╕╖р╕нр╕Хр╕│р╕лр╕Щр╕┤ р╣Ар╕Щр╣Йр╕Щр╕Бр╕▓р╕гр╕Кр╕бр╣Ар╕Кр╕вр╣Бр╕ер╕░р╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕Юр╕ер╕▒р╕Зр╕Ър╕зр╕Б (Positive Reinforcement)
┬а ┬а `;

┬а ┬а const response = await ai.models.generateContent({
┬а ┬а ┬а model: "gemini-2.5-flash",
┬а ┬а ┬а contents: prompt,
┬а ┬а ┬а config: {
┬а ┬а ┬а ┬а thinkingConfig: { thinkingBudget: 0 } 
┬а ┬а ┬а }
┬а ┬а });

┬а ┬а return response.text || "р╕Вр╕нр╕нр╕ар╕▒р╕в р╕гр╕░р╕Ър╕Ър╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╣Бр╕Щр╕░р╕Щр╕│р╣Др╕Фр╣Йр╣Гр╕Щр╕Вр╕Ур╕░р╕Щр╕╡р╣Й р╣Вр╕Ыр╕гр╕Фр╕ер╕нр╕Зр╣Гр╕лр╕бр╣Ир╕нр╕╡р╕Бр╕Др╕гр╕▒р╣Йр╕З";
┬а } catch (error) {
┬а ┬а console.error("Gemini API Error:", error);
┬а ┬а return "р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Вр╕▒р╕Фр╕Вр╣Йр╕нр╕Зр╣Гр╕Щр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ AI р╕Др╕гр╕╣р╣Бр╕Щр╕░р╣Бр╕Щр╕з (р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕нр╕┤р╕Щр╣Ар╕Чр╕нр╕гр╣Мр╣Ар╕Щр╣Зр╕Х)";
┬а }
};